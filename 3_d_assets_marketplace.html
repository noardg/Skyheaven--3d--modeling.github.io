<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3D Assets Marketplace — Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Optional: three.js for simple GLTF preview -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.152.2/examples/js/loaders/GLTFLoader.js"></script>
  <style>
    /* small helper to make local preview panes nicer */
    #viewer { width: 100%; height: 280px; background: #111; display:flex; align-items:center; justify-content:center; color:#ddd }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <header class="bg-white shadow">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-xl font-bold">3D Assets Market — Demo</h1>
      <nav class="space-x-2">
        <button class="nav-btn px-3 py-1 rounded bg-indigo-600 text-white" data-page="landing">Landing</button>
        <button class="nav-btn px-3 py-1 rounded bg-gray-100" data-page="manage">Manage</button>
        <button class="nav-btn px-3 py-1 rounded bg-gray-100" data-page="admin">Admin</button>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8">

    <!-- Landing page -->
    <section id="page-landing" class="page">
      <div class="grid md:grid-cols-2 gap-8 items-center">
        <div>
          <h2 class="text-3xl font-extrabold mb-2">Upload, Sell, and Discover 3D Assets</h2>
          <p class="text-gray-600 mb-4">Quick demo of an uploader for free or paid 3D assets. Frontend-only — stores data in your browser's localStorage. Replace the mock backend calls with your API later.</p>

          <div class="bg-white rounded shadow p-4">
            <h3 class="font-semibold mb-2">Upload an asset</h3>
            <form id="upload-form" class="space-y-3">
              <div>
                <label class="block text-sm font-medium">Title</label>
                <input id="asset-title" required class="mt-1 block w-full border rounded px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium">Description</label>
                <textarea id="asset-desc" rows="3" class="mt-1 block w-full border rounded px-3 py-2"></textarea>
              </div>
              <div>
                <label class="block text-sm font-medium">File (glb, obj, fbx, zip, or image as thumbnail)</label>
                <input id="asset-file" type="file" class="mt-1" accept=".glb,.gltf,.obj,.fbx,.zip,image/*" />
              </div>
              <div class="flex gap-4 items-center">
                <label class="inline-flex items-center">
                  <input id="asset-paid" type="checkbox" class="mr-2" />
                  <span>Paid asset</span>
                </label>
                <input id="asset-price" type="number" step="0.01" min="0" placeholder="Price (USD)" class="border rounded px-3 py-2" style="width:120px" disabled />
              </div>
              <div class="flex justify-end">
                <button type="submit" class="px-4 py-2 rounded bg-indigo-600 text-white">Upload</button>
              </div>
            </form>
            <p class="mt-2 text-sm text-gray-500">Note: This demo stores assets locally (localStorage). Implement server upload, authentication, payments, and file storage for production.</p>
          </div>

        </div>

        <div>
          <h3 class="font-semibold mb-2">Explore assets</h3>
          <div id="asset-list" class="space-y-3">
            <!-- items injected by JS -->
          </div>
        </div>
      </div>
    </section>

    <!-- Manage page -->
    <section id="page-manage" class="page hidden">
      <h2 class="text-2xl font-bold mb-4">Manage Your Uploads</h2>
      <div id="manage-list" class="space-y-4">
        <!-- items injected by JS -->
      </div>
    </section>

    <!-- Admin page -->
    <section id="page-admin" class="page hidden">
      <h2 class="text-2xl font-bold mb-4">Admin — Approve & Moderate</h2>
      <div id="admin-list" class="space-y-4">
        <!-- items injected by JS -->
      </div>
      <div class="mt-6 bg-white p-4 rounded shadow">
        <h3 class="font-semibold">Admin Actions</h3>
        <p class="text-sm text-gray-600">This demo includes simple approve/reject controls. In production, secure this page behind admin auth.</p>
      </div>
    </section>

  </main>

  <footer class="max-w-6xl mx-auto px-4 py-6 text-center text-sm text-gray-500">
    Demo marketplace — no real payments. Data is stored locally in your browser.
  </footer>

  <!-- Viewer modal for 3D preview (uses three.js for .glb) -->
  <div id="viewer-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4">
    <div class="bg-white rounded shadow max-w-4xl w-full overflow-hidden">
      <div class="flex items-center justify-between p-3 border-b">
        <strong id="viewer-title">Preview</strong>
        <button id="viewer-close" class="px-3 py-1">Close</button>
      </div>
      <div id="viewer" ></div>
    </div>
  </div>

  <script>
    // Simple SPA navigation
    document.querySelectorAll('.nav-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const page = btn.dataset.page;
        document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));
        document.getElementById('page-'+page).classList.remove('hidden');
        document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('bg-indigo-600','text-white'));
        btn.classList.add('bg-indigo-600','text-white');
        renderAll();
      })
    });

    // price toggle
    const paidCheckbox = document.getElementById('asset-paid');
    const priceInput = document.getElementById('asset-price');
    paidCheckbox.addEventListener('change', ()=> priceInput.disabled = !paidCheckbox.checked);

    // storage key
    const STORAGE_KEY = 'demo_3d_assets_v1';

    // load or init
    function loadAssets(){
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
      catch(e){ return []; }
    }
    function saveAssets(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }

    // sample seed if empty
    if(loadAssets().length===0){
      const sample = [
        {id: id(), title:'Low-poly tree', desc:'Free low-poly tree, OBJ', filename:'tree.obj', paid:false, price:0, status:'approved', uploader:'you', created: Date.now()},
        {id: id(), title:'Sci-fi helmet', desc:'Detailed GLB helmet', filename:'helmet.glb', paid:true, price:4.99, status:'pending', uploader:'alice', created: Date.now()-1000000}
      ]; saveAssets(sample);
    }

    // helpers
    function id(){ return 'a_'+Math.random().toString(36).slice(2,9); }
    function formatPrice(p){ return Number(p).toFixed(2); }
    function timeAgo(ts){ const s = Math.floor((Date.now()-ts)/1000); if(s<60) return s+'s ago'; if(s<3600) return Math.floor(s/60)+'m ago'; if(s<86400) return Math.floor(s/3600)+'h ago'; return Math.floor(s/86400)+'d ago'; }

    // Render functions
    function renderAssetCard(asset, container, options={}){
      const div = document.createElement('div');
      div.className = 'bg-white p-3 rounded shadow flex items-start gap-3';
      div.innerHTML = `
        <div class="w-20 h-20 bg-gray-100 rounded flex items-center justify-center text-xs text-gray-500">${asset.filename.split('.').pop().toUpperCase()}</div>
        <div class="flex-1">
          <div class="flex justify-between items-start">
            <div>
              <strong>${escapeHtml(asset.title)}</strong>
              <div class="text-sm text-gray-600">${escapeHtml(asset.desc)}</div>
              <div class="text-xs text-gray-400 mt-1">Uploaded ${timeAgo(asset.created)} • ${asset.uploader} • Status: ${asset.status}</div>
            </div>
            <div class="text-right">
              <div class="font-semibold">${asset.paid? '$'+formatPrice(asset.price) : 'Free'}</div>
            </div>
          </div>
        </div>
      `;

      // actions
      const actions = document.createElement('div'); actions.className='flex gap-2 items-center';
      const viewBtn = document.createElement('button'); viewBtn.className='px-3 py-1 rounded bg-gray-100 text-sm'; viewBtn.textContent='Preview';
      viewBtn.addEventListener('click', ()=> openPreview(asset));
      actions.appendChild(viewBtn);

      if(options.canManage){
        const editBtn = document.createElement('button'); editBtn.className='px-3 py-1 rounded bg-yellow-100 text-sm'; editBtn.textContent='Edit';
        editBtn.addEventListener('click', ()=> editAsset(asset.id));
        const delBtn = document.createElement('button'); delBtn.className='px-3 py-1 rounded bg-red-100 text-sm'; delBtn.textContent='Delete';
        delBtn.addEventListener('click', ()=> deleteAsset(asset.id));
        actions.appendChild(editBtn); actions.appendChild(delBtn);
      }

      if(options.canBuy && asset.paid && asset.status==='approved'){
        const buyBtn = document.createElement('button'); buyBtn.className='px-3 py-1 rounded bg-green-600 text-white text-sm'; buyBtn.textContent='Buy';
        buyBtn.addEventListener('click', ()=> mockPurchase(asset.id));
        actions.appendChild(buyBtn);
      }

      if(options.isAdmin){
        const approve = document.createElement('button'); approve.className='px-3 py-1 rounded bg-indigo-600 text-white text-sm'; approve.textContent='Approve'; approve.addEventListener('click', ()=> adminAction(asset.id,'approve'));
        const reject = document.createElement('button'); reject.className='px-3 py-1 rounded bg-red-600 text-white text-sm'; reject.textContent='Reject'; reject.addEventListener('click', ()=> adminAction(asset.id,'reject'));
        actions.appendChild(approve); actions.appendChild(reject);
      }

      div.appendChild(actions);
      container.appendChild(div);
    }

    function renderAll(){
      // landing asset list: show approved assets
      const assets = loadAssets();
      const list = document.getElementById('asset-list'); list.innerHTML='';
      assets.filter(a=>a.status==='approved').forEach(a=> renderAssetCard(a,list,{canBuy:true}));

      // manage
      const manage = document.getElementById('manage-list'); manage.innerHTML='';
      assets.forEach(a=> renderAssetCard(a,manage,{canManage:true}));

      // admin
      const admin = document.getElementById('admin-list'); admin.innerHTML='';
      assets.filter(a=>a.status!=='approved').forEach(a=> renderAssetCard(a,admin,{isAdmin:true}));

    }

    // escape to avoid HTML injection in demo
    function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    // form submit: store asset object, file stored as data URL for demo
    document.getElementById('upload-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const title = document.getElementById('asset-title').value.trim();
      const desc = document.getElementById('asset-desc').value.trim();
      const fileInput = document.getElementById('asset-file');
      const paid = document.getElementById('asset-paid').checked;
      const price = paid ? Number(document.getElementById('asset-price').value || 0) : 0;

      if(!title){ alert('Title required'); return; }

      let filename = 'no-file'; let dataurl = null;
      if(fileInput.files.length>0){
        const f = fileInput.files[0]; filename = f.name;
        // only read small files as dataURL for demo convenience
        dataurl = await fileToDataURL(f);
      }

      const newAsset = { id: id(), title, desc, filename, dataurl, paid, price, status: 'pending', uploader: 'you', created: Date.now() };
      const arr = loadAssets(); arr.unshift(newAsset); saveAssets(arr);
      alert('Uploaded — status: pending. Admin must approve (demo).');
      document.getElementById('upload-form').reset(); document.getElementById('asset-price').disabled=true;
      renderAll();
    });

    function fileToDataURL(file){ return new Promise((res,rej)=>{ const reader=new FileReader(); reader.onload=()=>res(reader.result); reader.onerror=rej; reader.readAsDataURL(file); }); }

    // manage functions
    function editAsset(id_){
      const arr = loadAssets(); const idx = arr.findIndex(a=>a.id===id_); if(idx===-1) return alert('Not found');
      const a = arr[idx];
      const newTitle = prompt('Edit title', a.title); if(newTitle===null) return;
      a.title = newTitle; arr[idx]=a; saveAssets(arr); renderAll();
    }
    function deleteAsset(id_){ if(!confirm('Delete this asset?')) return; const arr = loadAssets().filter(a=>a.id!==id_); saveAssets(arr); renderAll(); }

    // admin
    function adminAction(id_, action){ const arr = loadAssets(); const idx = arr.findIndex(a=>a.id===id_); if(idx===-1) return; if(action==='approve'){ arr[idx].status='approved'; } else { arr[idx].status='rejected'; } saveAssets(arr); renderAll(); }

    // mock purchase (no real payments)
    function mockPurchase(id_){ const arr = loadAssets(); const a = arr.find(x=>x.id===id_); if(!a) return; if(!confirm('Mock buy "'+a.title+'" for $'+formatPrice(a.price)+'? (demo)')) return; // mark as purchased in localStorage
      const purchases = JSON.parse(localStorage.getItem('demo_purchases_v1')||'[]'); purchases.push({assetId:id_, at:Date.now(), price:a.price}); localStorage.setItem('demo_purchases_v1', JSON.stringify(purchases)); alert('Purchase complete (demo). You can download the file if stored.'); }

    // preview
    let currentRenderer = null, currentScene=null, currentCamera=null;
    function openPreview(asset){
      document.getElementById('viewer-modal').classList.remove('hidden');
      document.getElementById('viewer-title').textContent = asset.title + ' — ' + asset.filename;
      const ext = asset.filename.split('.').pop().toLowerCase();
      const viewer = document.getElementById('viewer'); viewer.innerHTML='';

      // if it's an image data url or image file, show it
      if(asset.dataurl && asset.dataurl.startsWith('data:image')){
        const img = document.createElement('img'); img.src=asset.dataurl; img.style.maxWidth='100%'; img.style.maxHeight='520px'; viewer.appendChild(img); return;
      }

      // if glb and we have a dataurl, try three.js GLTFLoader
      if((ext==='glb' || ext==='gltf') && asset.dataurl && asset.dataurl.startsWith('data:')){
        try{ renderGLBFromDataURL(asset.dataurl, viewer); }catch(e){ viewer.textContent='Preview failed: '+e.message; }
        return;
      }

      viewer.innerHTML = '<div class="text-center text-gray-300">No preview available for this file type. Filename: '+escapeHtml(asset.filename)+'</div>';
    }

    document.getElementById('viewer-close').addEventListener('click', ()=>{ document.getElementById('viewer-modal').classList.add('hidden'); // dispose three.js renderer
      if(currentRenderer){ currentRenderer.dispose(); currentRenderer=null; currentScene=null; currentCamera=null; }
    });

    function renderGLBFromDataURL(dataurl, container){
      // cleanup
      if(currentRenderer){ currentRenderer.forceContextLoss(); currentRenderer.domElement.remove(); currentRenderer=null; }
      const canvas = document.createElement('div'); canvas.style.width='100%'; canvas.style.height='420px'; container.appendChild(canvas);

      const scene = new THREE.Scene();
      const renderer = new THREE.WebGLRenderer({antialias:true}); renderer.setSize(canvas.clientWidth, 420); canvas.appendChild(renderer.domElement);
      const camera = new THREE.PerspectiveCamera(45, canvas.clientWidth/420, 0.1, 1000); camera.position.set(0,1.5,3);
      const light = new THREE.HemisphereLight(0xffffff,0x444444,1.2); scene.add(light);

      const loader = new THREE.GLTFLoader();
      // GLTFLoader can accept blob URLs — convert dataurl to blob
      const blob = dataURLtoBlob(dataurl);
      const url = URL.createObjectURL(blob);
      loader.load(url, (gltf)=>{
        scene.add(gltf.scene);
        animate();
      }, undefined, (err)=>{ container.innerHTML = '<div class="text-red-400">Preview error: '+err.message+'</div>'; });

      function animate(){ requestAnimationFrame(animate); renderer.render(scene,camera); }
      currentRenderer = renderer; currentScene = scene; currentCamera = camera;
    }
    function dataURLtoBlob(dataurl){ const parts = dataurl.split(','); const m = parts[0].match(/:(.*?);/); const mime = m?m[1]:'application/octet-stream'; const bin = atob(parts[1]); let arr = new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i); return new Blob([arr], {type:mime}); }

    // small edit: initial render
    renderAll();

  </script>
</body>
</html>
